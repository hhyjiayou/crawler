/*! operationmaintenancesystem - v1.0.0 - 2016-09-05 */"use strict";var ResourceManageApp=angular.module("ResourceManageApp",["ngAnimate","ngCookies","ngResource","ngRoute","ngSanitize","ngTouch","commonModule"]);ResourceManageApp.config(function($routeProvider){$routeProvider.when("/resource_management/commit",{templateUrl:"/crawler/views/resource_man/commit.html",controller:"commitController"}).otherwise({redirectTo:"/resource_management/commit"})}),ResourceManageApp.controller("leftNav",["$scope","commitNav",function($scope,commitNav){$scope.navs=commitNav,$scope.changeClass=commitNav.changeClass.bind(this,$scope.navs.nav)}]),ResourceManageApp.controller("commitController",["$scope","Util","commitNav","requestConfig","commonData","$timeout",function($scope,Util,commitNav,requestConfig,commonData,$timeout){function loading_fn(){$scope.loading=!0,$scope.handlerAjax("process","处理中...")}$scope.configs=requestConfig.commit,$scope.pullcommitParams={pages:1,crawlerUrl:"",netType:1,start:1,limit:20,postBarType:{hot:!0,news:!1}},$scope.loadcommitParams={pages:1,feedId:"",feedOwnerId:"",start:1,limit:10},$scope.confirmContent=commonData.confirmContent,$scope.alert=commonData.alert,$scope.$watch("pullcommitParams.start",function(){""!=$scope.pullcommitParams.crawlerUrl&&$scope.pullCommit("page")}),$scope.$watch("loadcommitParams.start",function(){if(""!=$scope.loadcommitParams.feedId){$scope.loadcommitData=[],$scope.allcheck=!1;var startIndex=($scope.loadcommitParams.start-1)*$scope.commitPerPage,i=startIndex,end=startIndex+$scope.commitPerPage,remainCount=$scope.allComments.length-startIndex;for(remainCount<$scope.commitPerPage&&(end=startIndex+remainCount);end>i;i++){var item=$scope.allComments[i];item.isChecked=!1,$scope.loadcommitData.push($scope.allComments[i])}}}),$scope.$watch("allComments.length",function(){if(""!=$scope.loadcommitParams.feedId){var total_count=$scope.allComments.length;$scope.loadcommitParams.pages=total_count%$scope.commitPerPage?parseInt(total_count/$scope.commitPerPage)+1:parseInt(total_count/$scope.commitPerPage),$scope.loadcommitData=[],$scope.loadcommitParams.start>$scope.loadcommitParams.pages&&$scope.loadcommitParams.start--;var startIndex=($scope.loadcommitParams.start-1)*$scope.commitPerPage,i=startIndex,end=startIndex+$scope.commitPerPage,remainCount=$scope.allComments.length-startIndex;for(remainCount<$scope.commitPerPage&&(end=startIndex+remainCount),$scope.allcheck=!1;end>i;i++){var item=$scope.allComments[i];item.isChecked=!1,$scope.loadcommitData.push($scope.allComments[i])}}}),$scope.$watch("pullcommitParams.crawlerUrl",function(){$scope.pullcommitParams.start=1,$scope.commitData=[],$scope.flag=!1}),$scope.$watch("pullcommitParams.postBarType.hot",function(){$scope.pullcommitParams.start=1,$scope.commitData=[],$scope.flag=!1}),$scope.$watch("pullcommitParams.postBarType.news",function(){$scope.pullcommitParams.start=1,$scope.commitData=[],$scope.flag=!1}),$scope.commitTable={title:"评论管理",thead:[{name:"栏目序列",style:"td_Fifteen"},{name:"评论内容",style:"td_74"},{name:"用户ID",style:"td_Fifteen"},{name:"操作",style:"td_Fifteen"}]},$scope.commitTableLoad={title:"评论管理",thead:[{name:"栏目序列",style:"td_Fifteen"},{name:"评论内容",style:"td_74"},{name:"用户ID",style:"td_Fifteen"},{name:"操作",style:"td_five"},{name:"删除",style:"delBtn",click:!0},{name:"",style:"td_five"}]},$scope.flag=!1,$scope.nextBtn=!0,$scope.allcheck=!1,$scope.toutiaoTip=!1,$scope.clickAll=function(){if($scope.allcheck=$scope.allcheck?!1:!0,$scope.allcheck)for(var i=0;i<$scope.loadcommitData.length;i++){var item=$scope.loadcommitData[i];item.isChecked=!0}else for(var i=0;i<$scope.loadcommitData.length;i++){var item=$scope.loadcommitData[i];item.isChecked=!1}},$scope.commitData=[],$scope.pullCommit=function(tag){if(!Util.IsURL($scope.pullcommitParams.crawlerUrl))return void $scope.handlerAjax("fail","地址不能为空或格式不正确");var toutiaoReg=/^http:\/\/(www.)*toutiao\.com/;if(toutiaoReg.test($scope.pullcommitParams.crawlerUrl))$scope.toutiaoTip=!0;else if($scope.toutiaoTip=!1,!$scope.pullcommitParams.postBarType.hot&&!$scope.pullcommitParams.postBarType.news)return void $scope.handlerAjax("fail","请选择评论类型");$scope.configs.pullcommit.transformRequest=function(){$scope.loading=!0};var postBarType=[1];$scope.pullcommitParams.postBarType.hot&&$scope.pullcommitParams.postBarType.news&&(postBarType=[1,2]),!$scope.pullcommitParams.postBarType.hot&&$scope.pullcommitParams.postBarType.news&&(postBarType=[2]),$scope.pullcommitParams.postBarType.hot&&!$scope.pullcommitParams.postBarType.news&&(postBarType=[1]),$scope.configs.pullcommit.transformRequest=loading_fn;var start_param=$scope.pullcommitParams.start-1;$scope.flag&&(start_param=$scope.pullcommitParams.start),$scope.configs.pullcommit.params={crawlerUrl:encodeURI($scope.pullcommitParams.crawlerUrl),limit:20,netType:$scope.pullcommitParams.netType,start:start_param,postBarType:postBarType},Util.query($scope.configs.pullcommit).then(function(response){var data=response.data;if(0==data.code){if($scope.loading=!1,$scope.nextBtn=!0,!(data.data.hot&&data.data.hot.postbar_data||data.data["new"]&&data.data["new"].postbar_data))return $scope.handlerAjax("success","没有更多数据了"),void($scope.nextBtn=!1);if((data.data["new"]&&0==data.data["new"].postbar_data.length||!data.data["new"])&&(data.data.hot&&0==data.data.hot.postbar_data.length||!data.data.hot))return $scope.handlerAjax("success","没有更多数据了"),void($scope.nextBtn=!1);$scope.commitData=[],$scope.handlerAjax("success",tag?"拉取数据成功":"爬取成功"),data.data["new"]&&data.data["new"].postbar_data&&data.data["new"].postbar_data.length&&(data.data["new"].postbar_data.forEach(function(item,index){$scope.commitData.push({content:item.content,uid:item.uid,checked:!1})}),$scope.pullcommitParams.pages=Math.ceil(data.data["new"].total_count/20)),data.data.hot&&data.data.hot.postbar_data&&data.data.hot.postbar_data.length&&(data.data.hot.postbar_data.forEach(function(item,index){$scope.commitData.push({content:item.content,uid:item.uid,checked:!1})}),$scope.pullcommitParams.pages+=Math.ceil(data.data.hot.total_count/20)),data.start!=$scope.configs.pullcommit.params.start&&($scope.flag=!0)}else $scope.handlerAjax("fail",data.msg)},function(err){$scope.handlerAjax("fail",err)})},$scope.allComments=[],$scope.commitPerPage=10,$scope.loadCommit=function(tag){if(!$scope.loadcommitParams.feedId)return void $scope.handlerAjax("fail","请填写feedId");var feedIdReg=/\_\d+$/;return feedIdReg.test($scope.loadcommitParams.feedId)?($scope.configs.loadFeedComments.transformRequest=loading_fn(),$scope.configs.loadFeedComments.params={feedId:$scope.loadcommitParams.feedId,start:0,limit:500},void Util.query($scope.configs.loadFeedComments).then(function(response){var data=response.data;if(0==data.code){if($scope.loading=!1,$scope.loadcommitParams.start=1,!data.total_count)return $scope.allComments=[],void $scope.handlerAjax("success","该Feed_ID没有评论可加载");if(data.data&&data.total_count){$scope.handlerAjax("success","加载评论成功"),$scope.allComments=[],$scope.loadcommitData=[],data.data.forEach(function(item,index){$scope.allComments.push({content:item.content,uid:item.uid,comment_id:item.comment_id,is_good:item.is_good,isChecked:!1,index:index})});var total_count=data.total_count,pages=total_count%$scope.commitPerPage?parseInt(total_count/$scope.commitPerPage)+1:parseInt(total_count/$scope.commitPerPage);$scope.loadcommitParams.pages=pages;for(var firstDataCount=total_count<$scope.commitPerPage?total_count:$scope.commitPerPage,i=0;firstDataCount>i;i++)$scope.loadcommitData.push($scope.allComments[i])}}else $scope.handlerAjax("fail",data.msg)},function(err){$scope.handlerAjax("fail",err)})):void $scope.handlerAjax("fail","请填写以下划线加数字结尾正确格式的feedId")},$scope.top=function(commit){if(!$scope.loadcommitParams.feedId||!$scope.loadcommitParams.feedOwnerId)return void $scope.handlerAjax("fail","请填写feedId和feedOwnerId");var feedIdReg=/\_\d+$/;return feedIdReg.test($scope.loadcommitParams.feedId)?($scope.configs.top.transformRequest=loading_fn(),$scope.configs.top.params={feedId:$scope.loadcommitParams.feedId,feedOwnerId:$scope.loadcommitParams.feedOwnerId,commentId:commit.comment_id},void Util.query($scope.configs.top).then(function(response){var data=response.data;0==data.code?($scope.loading=!1,$scope.handlerAjax("success","置顶成功"),commit.is_good=!0):$scope.handlerAjax("fail",data.msg)},function(err){$scope.handlerAjax("fail",err)})):void $scope.handlerAjax("fail","请填写以下划线加数字结尾正确格式的feedId")},$scope.autoPullCommit=function(){if(!$scope.loadcommitParams.feedId||!$scope.loadcommitParams.feedOwnerId)return void $scope.handlerAjax("fail","请填写feedId和feedOwnerId");var feedIdReg=/\_\d+$/;if(!feedIdReg.test($scope.loadcommitParams.feedId))return void $scope.handlerAjax("fail","请填写以下划线加数字结尾正确格式的feedId");if(!Util.IsURL($scope.pullcommitParams.crawlerUrl))return void $scope.handlerAjax("fail","地址不能为空或格式不正确");if(!$scope.pullcommitParams.postBarType.hot&&!$scope.pullcommitParams.postBarType.news)return void $scope.handlerAjax("fail","请选择评论类型");var postBarType=[1];$scope.pullcommitParams.postBarType.hot&&$scope.pullcommitParams.postBarType.news&&(postBarType=[1,2]),!$scope.pullcommitParams.postBarType.hot&&$scope.pullcommitParams.postBarType.news&&(postBarType=[2]),$scope.pullcommitParams.postBarType.hot&&!$scope.pullcommitParams.postBarType.news&&(postBarType=[1]),$scope.configs.autoPullCommit.transformRequest=loading_fn(),$scope.configs.autoPullCommit.params={crawlerUrl:encodeURI($scope.pullcommitParams.crawlerUrl),netType:$scope.pullcommitParams.netType,postBarType:postBarType,feedId:$scope.loadcommitParams.feedId,feedOwnerId:$scope.loadcommitParams.feedOwnerId},Util.query($scope.configs.autoPullCommit).then(function(response){var data=response.data;0==data.code&&($scope.loading=!1,$scope.handlerAjax("success",data.msg))},function(err){$scope.handlerAjax("fail",err)})},$scope.addCommit=function(commit){$scope.commit=commit,$scope.confirmContent={confirmShow:!0,title:"添加评论",msg_title:"确认要添加该条评论么？",msg:"确认要添加该条评论么？",btns:{cancel:{text:"取消",className:"btn-primary"},ok:{text:"添加",className:"btn-success",cb:"confirmaddcommit"}}}},$scope.loadcommitData=[],$scope.confirmaddcommit=function(commit){if(!$scope.loadcommitParams.feedId||!$scope.loadcommitParams.feedOwnerId)return void $scope.handlerAjax("fail","请填写feedId和feedOwnerId");var feedIdReg=/\_\d+$/;return feedIdReg.test($scope.loadcommitParams.feedId)?($scope.configs.addcommit.transformRequest=loading_fn,$scope.configs.addcommit.params={feedId:$scope.loadcommitParams.feedId,feedOwnerId:$scope.loadcommitParams.feedOwnerId,content:JSON.stringify([{content:commit.content,uid:commit.uid}])},void Util.query($scope.configs.addcommit).then(function(response){var data=response.data;0==data.code?($scope.loading=!1,$scope.handlerAjax("success","添加成功"),$scope.confirmContent.confirmShow=!1):$scope.handlerAjax("fail",data.data)},function(err){$scope.handlerAjax("fail",err)})):void $scope.handlerAjax("fail","请填写以下划线加数字结尾正确格式的feedId")},$scope.commentIds=[],$scope.indexes=[],$scope.deleteCommit=function(){$scope.commentIds=[],$scope.indexes=[];for(var i=0;i<$scope.loadcommitData.length;i++){var item=$scope.loadcommitData[i];item.isChecked&&($scope.commentIds.push(item.comment_id),$scope.indexes.push(item.index))}return $scope.commentIds.length?void($scope.confirmContent={confirmShow:!0,title:"删除评论",msg_title:"确认要删除该些评论吗？",msg:"确认要删除该些评论吗？",btns:{cancel:{text:"取消",className:"btn-primary"},ok:{text:"删除",className:"btn-success",cb:"confirmdelcommit"}}}):void $scope.handlerAjax("fail","请选择您要删除的评论")},$scope.confirmdelcommit=function(){if(!$scope.loadcommitParams.feedId)return void $scope.handlerAjax("fail","请填写feedId");var feedIdReg=/\_\d+$/;return feedIdReg.test($scope.loadcommitParams.feedId)?($scope.configs.delcommit.transformRequest=loading_fn,$scope.configs.delcommit.params={feedId:$scope.loadcommitParams.feedId,commentIds:$scope.commentIds},void Util.query($scope.configs.delcommit).then(function(response){var data=response.data;if(0==data.code){$scope.loading=!1,$scope.handlerAjax("success","删除成功"),$scope.confirmContent.confirmShow=!1;for(var i=0;i<$scope.indexes.length;i++)$scope.allComments.splice($scope.indexes[i],1,"");for(var len=$scope.allComments.length,index=0,i=0;len>i;i++){var item=$scope.allComments[i];""!=item&&(item.index=index,index++)}$scope.allComments=$scope.allComments.filter(function(item,index){return""!=item?item:void 0})}else $scope.handlerAjax("fail",data.msg)},function(err){$scope.handlerAjax("fail",err)})):void $scope.handlerAjax("fail","请填写以下划线加数字结尾正确格式的feedId")},$scope.handlerAjax=Util.showAlert.bind($scope),$scope.loading=!1}]);